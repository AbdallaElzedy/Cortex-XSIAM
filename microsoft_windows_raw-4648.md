```microsoft_windows_raw 4648 A computer account was changed
dataset = microsoft_windows_raw 
| filter event_id = 4648
// | filter event_data contains ""
| alter 
    subject_username = json_extract_scalar(to_json_string(event_data), "$.SubjectUserName"),
    subject_domain = json_extract_scalar(to_json_string(event_data), "$.SubjectDomainName"),
    subject_user_sid = json_extract_scalar(to_json_string(event_data), "$.SubjectUserSid"),
    subject_logon_id = json_extract_scalar(to_json_string(event_data), "$.SubjectLogonId"),
    subject_logon_guid = json_extract_scalar(to_json_string(event_data), "$.LogonGuid"),
    target_username = json_extract_scalar(to_json_string(event_data), "$.TargetUserName"),
    target_domain = json_extract_scalar(to_json_string(event_data), "$.TargetDomainName"),
    target_logon_guid = json_extract_scalar(to_json_string(event_data), "$.TargetLogonGuid"),
    target_server_name = json_extract_scalar(to_json_string(event_data), "$.TargetServerName"),
    target_info = json_extract_scalar(to_json_string(event_data), "$.TargetInfo"),
    process_id = json_extract_scalar(to_json_string(event_data), "$.ProcessId"),
    process_name_event = json_extract_scalar(to_json_string(event_data), "$.ProcessName"),
    source_ip = json_extract_scalar(to_json_string(event_data), "$.IpAddress"),
    source_port = json_extract_scalar(to_json_string(event_data), "$.IpPort"),
    event_host = host_name,
    collector_info = _collector_name
| alter 
    subject_user_full = concat(subject_domain, "\\", subject_username),
    target_user_full = concat(target_domain, "\\", target_username),
    subject_type = if(subject_username contains "$", "Computer_Account",
                      subject_user_sid = "S-1-5-18", "SYSTEM_Account",
                      subject_user_sid = "S-1-5-19", "LOCAL_SERVICE",
                      subject_user_sid = "S-1-5-20", "NETWORK_SERVICE",
                      "User_Account"),
    target_type = if(target_username contains "$", "Computer_Account", "User_Account"),
    target_location = if(target_server_name = "localhost" or target_server_name = target_info, "Local",
                         target_server_name contains ".", "Remote_FQDN",
                         "Remote_NetBIOS"),
    process_type = if(process_name_event contains "lsass.exe", "LSASS_Process",
                      process_name_event contains "winlogon.exe", "Winlogon_Process",
                      process_name_event contains "svchost.exe", "Service_Host",
                      process_name_event contains "taskeng.exe", "Task_Engine",
                      process_name_event contains "rundll32.exe", "Rundll32",
                      process_name_event contains "powershell.exe", "PowerShell",
                      process_name_event contains "cmd.exe", "Command_Prompt",
                      process_name_event contains "explorer.exe", "Windows_Explorer",
                      "Other_Process"),
    source_ip_type = if(incidr(source_ip, "10.0.0.0/8") or incidr(source_ip, "172.16.0.0/12") or incidr(source_ip, "192.168.0.0/16"), "Internal", 
                        source_ip = "127.0.0.1" or source_ip = "::1", "Loopback",
                        "External") | alter
    is_privilege_escalation = if(subject_type = "User_Account" and target_type = "User_Account" and subject_username != target_username, true, false),
    is_lateral_movement = if(target_location = "Remote_FQDN" or target_location = "Remote_NetBIOS", true, false),
    formatted_time = format_timestamp("%Y-%m-%d %H:%M:%S", _time),
    hour_of_day = extract_time(_time, "HOUR"),
    day_of_week = extract_time(_time, "DAYOFWEEK")
| comp 
    count() as total_explicit_logons,
    count_distinct(subject_user_full) as unique_subject_users,
    count_distinct(target_user_full) as unique_target_users,
    count_distinct(target_server_name) as unique_target_servers,
    count_distinct(source_ip) as unique_source_ips,
    count_distinct(process_name_event) as unique_processes,
    count_distinct(event_host) as unique_event_hosts,
    values(subject_user_full) as subject_users,
    values(target_user_full) as target_users,
    values(target_server_name) as target_servers,
    values(source_ip) as source_addresses,
    values(process_name_event) as process_names,
    values(event_host) as event_hosts,
    values(collector_info) as collectors,
    values(target_info) as target_information,
    values(source_port) as source_ports,
    values(hour_of_day) as active_hours,
    min(formatted_time) as first_occurrence,
    max(formatted_time) as last_occurrence,
    list(formatted_time) as sample_times,
    list(target_server_name) as sample_targets
by subject_type, target_type, target_location, process_type, source_ip_type, is_privilege_escalation, is_lateral_movement
| alter 
    sample_times_limited = arrayrange(sample_times, 0, 5),
    sample_targets_limited = arrayrange(sample_targets, 0, 5)
| fields 
    process_names,
    subject_users,
    target_users,
    total_explicit_logons,
    subject_type,
    target_type,
    target_location,
    process_type,
    source_ip_type,
    is_privilege_escalation,
    is_lateral_movement,
    unique_subject_users,
    unique_target_users,
    unique_target_servers,
    unique_source_ips,
    unique_processes,
    unique_event_hosts,
    target_servers,
    source_addresses,
    target_information,
    active_hours,
    first_occurrence,
    last_occurrence,
    sample_times_limited,
    sample_targets_limited,
    collectors
| sort desc total_explicit_logons

```

``` microsoft_windows_raw 4624  An account was successfully logged on

config timeframe between "14d" and "now"
| dataset = microsoft_windows_raw 
| filter event_id = 4624
// | filter event_data contains " "
| alter 
    target_username = json_extract_scalar(to_json_string(event_data), "$.TargetUserName"),
    target_domain = json_extract_scalar(to_json_string(event_data), "$.TargetDomainName"),
    target_user_sid = json_extract_scalar(to_json_string(event_data), "$.TargetUserSid"),
    target_logon_id = json_extract_scalar(to_json_string(event_data), "$.TargetLogonId"),
    target_linked_logon_id = json_extract_scalar(to_json_string(event_data), "$.TargetLinkedLogonId"),
    subject_username = json_extract_scalar(to_json_string(event_data), "$.SubjectUserName"),
    subject_domain = json_extract_scalar(to_json_string(event_data), "$.SubjectDomainName"),
    subject_user_sid = json_extract_scalar(to_json_string(event_data), "$.SubjectUserSid"),
    subject_logon_id = json_extract_scalar(to_json_string(event_data), "$.SubjectLogonId"),
    logon_type = json_extract_scalar(to_json_string(event_data), "$.LogonType"),
    logon_process = json_extract_scalar(to_json_string(event_data), "$.LogonProcessName"),
    auth_package = json_extract_scalar(to_json_string(event_data), "$.AuthenticationPackageName"),
    workstation_name = json_extract_scalar(to_json_string(event_data), "$.WorkstationName"),
    source_ip = json_extract_scalar(to_json_string(event_data), "$.IpAddress"),
    source_port = json_extract_scalar(to_json_string(event_data), "$.IpPort"),
    process_id = json_extract_scalar(to_json_string(event_data), "$.ProcessId"),
    process_name_event = json_extract_scalar(to_json_string(event_data), "$.ProcessName"),
    logon_guid = json_extract_scalar(to_json_string(event_data), "$.LogonGuid"),
    lm_package_name = json_extract_scalar(to_json_string(event_data), "$.LmPackageName"),
    key_length = json_extract_scalar(to_json_string(event_data), "$.KeyLength"),
    impersonation_level = json_extract_scalar(to_json_string(event_data), "$.ImpersonationLevel"),
    elevated_token = json_extract_scalar(to_json_string(event_data), "$.ElevatedToken"),
    virtual_account = json_extract_scalar(to_json_string(event_data), "$.VirtualAccount"),
    restricted_admin_mode = json_extract_scalar(to_json_string(event_data), "$.RestrictedAdminMode"),
    transmitted_services = json_extract_scalar(to_json_string(event_data), "$.TransmittedServices"),
    target_outbound_username = json_extract_scalar(to_json_string(event_data), "$.TargetOutboundUserName"),
    target_outbound_domain = json_extract_scalar(to_json_string(event_data), "$.TargetOutboundDomainName"),
    target_server = host_name,
    os_version = os_subtype,
    lsass_process = process_name,
    message_content = message
| alter 
    target_user_full = concat(target_domain, "\\", target_username),
    subject_user_full = if(subject_username = "-", "SYSTEM", concat(subject_domain, "\\", subject_username)),
    logon_type_desc = if(logon_type = "2", "Interactive",
                         logon_type = "3", "Network",
                         logon_type = "4", "Batch",
                         logon_type = "5", "Service",
                         logon_type = "7", "Unlock",
                         logon_type = "8", "NetworkCleartext",
                         logon_type = "9", "NewCredentials",
                         logon_type = "10", "RemoteInteractive",
                         logon_type = "11", "CachedInteractive",
                         concat("Type_", logon_type)),
    auth_protocol = if(auth_package contains "NTLM", "NTLM",
                       auth_package contains "Kerberos", "Kerberos",
                       auth_package contains "Negotiate", "Negotiate",
                       auth_package),
    ntlm_version = if(lm_package_name contains "NTLM V2", "NTLM_v2",
                      lm_package_name contains "NTLM V1", "NTLM_v1",
                      lm_package_name contains "LM", "LM_Legacy",
                      lm_package_name),
    source_ip_type = if(incidr(source_ip, "10.0.0.0/8") or incidr(source_ip, "172.16.0.0/12") or incidr(source_ip, "192.168.0.0/16"), "Internal", 
                        source_ip = "127.0.0.1" or source_ip = "::1", "Loopback",
                        source_ip = "-" or source_ip = "", "No_Network",
                        "External"),
    workstation_clean = if(workstation_name = "-" or workstation_name = "", "Unknown", workstation_name),
    elevation_status = if(elevated_token = "%%1842", "Elevated", 
                          elevated_token = "%%1843", "Not_Elevated",
                          elevated_token),
    account_type = if(virtual_account = "%%1842", "Virtual_Account",
                      virtual_account = "%%1843", "Regular_Account",
                      virtual_account),
    impersonation_desc = if(impersonation_level = "%%1832", "Anonymous",
                            impersonation_level = "%%1833", "Identification", 
                            impersonation_level = "%%1834", "Impersonation",
                            impersonation_level = "%%1835", "Delegation",
                            impersonation_level),
    has_linked_logon = if(target_linked_logon_id != "0x0" and target_linked_logon_id != "", true, false),
    key_strength = if(to_integer(key_length) >= 128, "Strong_Encryption",
                      to_integer(key_length) >= 56, "Medium_Encryption", 
                      to_integer(key_length) > 0, "Weak_Encryption",
                      "No_Encryption"),
    formatted_time = format_timestamp("%Y-%m-%d %H:%M:%S", _time),
    hour_of_day = extract_time(_time, "HOUR"),
    day_of_week = extract_time(_time, "DAYOFWEEK"),
    date_only = format_timestamp("%Y-%m-%d", _time)
| comp 
    count() as total_successful_logons,
    count_distinct(target_user_full) as unique_target_users,
    count_distinct(source_ip) as unique_source_ips,
    count_distinct(target_server) as unique_target_servers,
    count_distinct(workstation_clean) as unique_workstations,
    count_distinct(target_logon_id) as unique_logon_sessions,
    count_distinct(date_only) as days_active,
    values(target_user_full) as target_users,
    values(subject_user_full) as subject_users,
    values(source_ip) as source_addresses,
    values(target_server) as target_servers,
    values(workstation_clean) as workstation_names,
    values(source_port) as source_ports,
    values(logon_process) as logon_processes,
    values(process_name_event) as process_names,
    values(os_version) as operating_systems,
    values(hour_of_day) as active_hours,
    values(day_of_week) as active_days,
    values(key_length) as key_lengths,
    values(transmitted_services) as service_chains,
    list(message_content) as sample_messages,
    min(formatted_time) as first_logon,
    max(formatted_time) as last_logon,
    list(formatted_time) as sample_times,
    list(source_ip) as sample_source_ips
by logon_type_desc, auth_protocol, ntlm_version, source_ip_type, elevation_status, account_type, impersonation_desc, has_linked_logon, key_strength
| alter 
    activity_duration_days = if(days_active > 1, timestamp_diff(parse_timestamp("%Y-%m-%d %H:%M:%S", last_logon), parse_timestamp("%Y-%m-%d %H:%M:%S", first_logon), "DAY"), 0),
    avg_logons_per_day = if(days_active > 0, divide(total_successful_logons, days_active), total_successful_logons),
    sample_times_limited = arrayrange(sample_times, 0, 5),
    sample_ips_limited = arrayrange(sample_source_ips, 0, 5),
    sample_messages_limited = arrayrange(sample_messages, 0, 2)
| fields 
    target_servers,
    workstation_names,
    total_successful_logons,
    logon_type_desc,
    auth_protocol,
    ntlm_version,
    source_ip_type,
    elevation_status,
    account_type,
    impersonation_desc,
    has_linked_logon,
    key_strength,
    unique_target_users,
    unique_source_ips,
    unique_target_servers,
    unique_workstations,
    unique_logon_sessions,
    days_active,
    activity_duration_days,
    avg_logons_per_day,
    target_users,
    source_addresses,
    logon_processes,
    active_hours,
    active_days,
    key_lengths,
    service_chains,
    first_logon,
    last_logon,
    sample_times_limited,
    sample_ips_limited,
    sample_messages_limited,
    operating_systems
| sort desc total_successful_logons

```
